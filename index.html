<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CricketField Scorer - Classic Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #166534; /* Dark Green */
            background-image: url('https://www.transparenttextures.com/patterns/crissxcross.png');
        }
        .font-roboto-slab { font-family: 'Roboto Slab', serif; }
        
        .nav-link {
            position: relative;
            transition: color 0.3s;
            letter-spacing: 0.05em;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f59e0b; /* Amber */
            transition: width 0.3s ease-in-out;
        }
        .nav-link:hover, .nav-link.active {
            color: #f59e0b;
        }
        .nav-link:hover::after, .nav-link.active::after {
            width: 100%;
        }

        .form-input {
            @apply w-full px-2 py-2 text-gray-800 bg-white border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-700 focus:border-red-700 transition-all text-center text-2xl font-bold;
        }
        .btn {
            @apply px-8 py-3 font-bold rounded-md transition-all transform hover:scale-105 shadow-lg w-full sm:w-auto uppercase tracking-wider;
        }
        .btn-primary { @apply bg-red-700 hover:bg-red-800 text-white shadow-red-900/30; }
        .btn-secondary { @apply bg-gray-600 hover:bg-gray-700 text-white shadow-gray-500/20; }
        .btn-danger { @apply bg-gray-800 hover:bg-black text-white; }
        
        .section { display: none; }
        .section.active { display: block; }
        
        .player-row input::-webkit-outer-spin-button,
        .player-row input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .player-row input { -moz-appearance: textfield; }
        
        .card {
            background-color: #f8fafc; /* Slate 50 */
            border: 1px solid #e2e8f0; /* Slate 200 */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        
        .dismissal-btn {
            @apply px-3 py-1 text-xs border-2 border-gray-300 text-gray-600 rounded-full cursor-pointer transition-all duration-200 hover:border-red-700 hover:bg-red-100;
        }
        .dismissal-btn.selected {
            @apply bg-red-700 text-white border-red-700 font-bold;
        }
        .disabled-ui {
            pointer-events: none;
            opacity: 0.7;
        }
         .loader-spin {
             border-color: #9ca3af;
             border-top-color: #be123c;
             animation: spin 1s linear infinite;
        }
        @keyframes spin {
          to {
            transform: rotate(360deg);
          }
        }
    </style>
</head>
<body class="bg-green-800 text-gray-800">

    <!-- Header -->
    <header class="bg-green-900 shadow-2xl sticky top-0 z-50 border-b-4 border-yellow-400">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl sm:text-4xl font-roboto-slab font-bold text-white tracking-wider cursor-pointer" onclick="goHome()">
                    Cricket Scorer
                </h1>
                <nav class="hidden md:flex space-x-10 text-white font-semibold items-center text-sm uppercase">
                    <a onclick="showSection('home')" class="nav-link active">Home</a>
                    <a onclick="showSection('create-match')" class="nav-link">Scorecard</a>
                    <a onclick="showSection('view-prediction')" class="nav-link">Result</a>
                    <a onclick="showSection('contact')" class="nav-link">Contact</a>
                </nav>
                <button id="mobile-menu-button" class="md:hidden text-white focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-green-900 border-t border-green-800">
            <a onclick="showSection('home', true)" class="block text-white py-4 px-4 hover:bg-yellow-400 hover:text-black transition-colors font-semibold">Home</a>
            <a onclick="showSection('create-match', true)" class="block text-white py-4 px-4 hover:bg-yellow-400 hover:text-black transition-colors font-semibold">Scorecard</a>
            <a onclick="showSection('view-prediction', true)" class="block text-white py-4 px-4 hover:bg-yellow-400 hover:text-black transition-colors font-semibold">Result</a>
            <a onclick="showSection('contact', true)" class="block text-white py-4 px-4 hover:bg-yellow-400 hover:text-black transition-colors font-semibold">Contact</a>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Home Section / Lobby -->
        <section id="home" class="section active">
            <div class="card rounded-xl p-8 md:p-12 text-center shadow-xl">
                <h2 class="text-5xl md:text-6xl font-roboto-slab font-bold text-gray-800 mb-4">Welcome</h2>
                <p class="text-lg text-gray-600 max-w-2xl mx-auto mb-10">Host a new match to get a shareable Room ID, or join an existing match to view the live score.</p>
                <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                    <div class="bg-gray-100 p-8 rounded-lg border border-gray-200">
                        <h3 class="text-3xl font-roboto-slab text-gray-800 mb-4">Host a Match</h3>
                        <p class="text-gray-600 mb-6">Create a new room and start scoring. You'll be the only one who can edit the scorecard.</p>
                        <button onclick="createRoom()" class="btn btn-primary">Create New Room</button>
                    </div>
                     <div class="bg-gray-100 p-8 rounded-lg border border-gray-200">
                        <h3 class="text-3xl font-roboto-slab text-gray-800 mb-4">Join a Match</h3>
                        <p class="text-gray-600 mb-6">Enter a Room ID to watch a match in progress. The score will update live.</p>
                        <div class="flex gap-2">
                             <input type="text" id="joinRoomInput" class="form-input !text-left !text-lg !font-normal" placeholder="Enter Room ID">
                             <button onclick="joinRoom()" class="btn btn-secondary !px-6">Join</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Create Match Section -->
        <section id="create-match" class="section">
            <div id="room-info" class="hidden card p-4 rounded-xl shadow-lg mb-6 text-center bg-blue-600 text-white">
                <h3 class="text-lg font-bold">Share this Room to Invite Viewers!</h3>
                <div class="flex items-center justify-center gap-4 mt-2">
                    <span class="font-mono text-2xl" id="roomIdDisplay"></span>
                    <button onclick="copyRoomId()" class="bg-white/20 hover:bg-white/40 p-2 rounded-md">Copy ID</button>
                </div>
            </div>
             <div id="scorecard-container" class="card p-6 sm:p-8 rounded-xl shadow-xl">
                <div id="scorecard-loader" class="hidden text-center p-16">
                    <div class="loader-spin rounded-full h-12 w-12 border-4 mx-auto"></div>
                    <p class="mt-4 font-semibold text-gray-600" id="loader-text">Loading room...</p>
                </div>
                <div id="scorecard-content" class="hidden">
                    <h2 class="text-4xl sm:text-5xl font-roboto-slab font-bold text-gray-800 mb-8 border-b-2 border-gray-200 pb-4">Match Scorecard</h2>
                    <div class="grid md:grid-cols-2 gap-x-8 gap-y-6 mb-10">
                        <div>
                            <label for="myTeamName" class="block text-sm font-semibold text-gray-600 mb-2">Your Team Name</label>
                            <input type="text" id="myTeamName" oninput="saveMatchData()" class="form-input !text-left !text-lg !font-normal" placeholder="E.g., Team A">
                        </div>
                        <div>
                            <label for="opponentTeamName" class="block text-sm font-semibold text-gray-600 mb-2">Opponent's Team Name</label>
                            <input type="text" id="opponentTeamName" oninput="saveMatchData()" class="form-input !text-left !text-lg !font-normal" placeholder="E.g., Team B">
                        </div>
                    </div>
                    <div class="grid lg:grid-cols-2 gap-12">
                        <div class="flex flex-col">
                            <h3 id="myTeamSectionHeader" class="text-3xl font-roboto-slab font-semibold text-gray-800 mb-4">My Team</h3>
                            <div id="myTeamPlayers" class="space-y-4 flex-grow"></div>
                            <div class="mt-4"><button onclick="addPlayer('myTeam')" class="btn btn-secondary text-sm">Add Player</button></div>
                        </div>
                        <div class="flex flex-col">
                            <h3 id="opponentTeamSectionHeader" class="text-3xl font-roboto-slab font-semibold text-gray-800 mb-4">Opponent Team</h3>
                            <div id="opponentTeamPlayers" class="space-y-4 flex-grow"></div>
                            <div class="mt-4"><button onclick="addPlayer('opponentTeam')" class="btn btn-secondary text-sm">Add Player</button></div>
                        </div>
                    </div>
                    <div id="host-controls" class="mt-10 pt-6 border-t-2 border-gray-200 flex flex-col sm:flex-row justify-center items-center gap-4">
                        <button onclick="showSection('view-prediction')" class="btn btn-primary font-roboto-slab text-xl">View Final Result</button>
                        <button onclick="clearAllData()" class="btn btn-danger">Clear All</button>
                    </div>
                </div>
             </div>
        </section>

        <!-- View Result Section -->
        <section id="view-prediction" class="section">
             <div class="card p-6 sm:p-8 rounded-xl shadow-xl">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b-2 border-gray-200 pb-4">
                    <h2 class="text-5xl font-roboto-slab font-bold text-gray-800">Match Result</h2>
                    <button id="downloadCsvBtn" onclick="downloadCSV()" class="btn btn-primary mt-4 sm:mt-0 text-sm">Download CSV</button>
                </div>
                <div id="winnerResult" class="hidden text-center bg-blue-600 text-white p-6 rounded-lg mb-8 shadow-xl">
                    <h3 class="text-5xl font-roboto-slab font-bold" id="winnerText"></h3>
                    <p class="font-semibold text-blue-100 mt-2" id="winnerReason"></p>
                </div>
                 <div id="predictionError" class="hidden text-center bg-red-100 border-2 border-red-200 text-red-700 p-4 rounded-md mb-8">
                    <p class="font-bold text-lg">No data found!</p>
                    <p class="text-sm">Please create a match and enter player stats first.</p>
                </div>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-3xl font-roboto-slab font-semibold text-gray-800 mb-4" id="myTeamResultHeader">My Team Stats</h3>
                        <div class="overflow-x-auto rounded-lg border-2 border-gray-200">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-200">
                                    <tr>
                                        <th class="py-3 px-4 text-left font-semibold uppercase text-gray-600">Player</th>
                                        <th class="py-3 px-4 text-left font-semibold uppercase text-gray-600">Dismissal</th>
                                        <th class="py-3 px-4 text-center font-semibold uppercase text-gray-600">R</th>
                                        <th class="py-3 px-4 text-center font-semibold uppercase text-gray-600">B</th>
                                        <th class="py-3 px-4 text-center font-semibold uppercase text-gray-600">SR</th>
                                    </tr>
                                </thead>
                                <tbody id="myTeamResultBody" class="divide-y divide-gray-200 bg-white"></tbody>
                            </table>
                        </div>
                         <div id="myTeamTotals" class="mt-4 font-bold text-right pr-2 text-lg"></div>
                    </div>
                    <div>
                        <h3 class="text-3xl font-roboto-slab font-semibold text-gray-800 mb-4" id="opponentTeamResultHeader">Opponent Team Stats</h3>
                         <div class="overflow-x-auto rounded-lg border-2 border-gray-200">
                             <table class="min-w-full text-sm">
                                <thead class="bg-gray-200">
                                    <tr>
                                        <th class="py-3 px-4 text-left font-semibold uppercase text-gray-600">Player</th>
                                        <th class="py-3 px-4 text-left font-semibold uppercase text-gray-600">Dismissal</th>
                                        <th class="py-3 px-4 text-center font-semibold uppercase text-gray-600">R</th>
                                        <th class="py-3 px-4 text-center font-semibold uppercase text-gray-600">B</th>
                                        <th class="py-3 px-4 text-center font-semibold uppercase text-gray-600">SR</th>
                                    </tr>
                                </thead>
                                <tbody id="opponentTeamResultBody" class="divide-y divide-gray-200 bg-white"></tbody>
                            </table>
                        </div>
                        <div id="opponentTeamTotals" class="mt-4 font-bold text-right pr-2 text-lg"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Contact Section -->
        <section id="contact" class="section">
             <div class="card p-8 rounded-xl shadow-xl text-center">
                <h2 class="text-5xl font-roboto-slab font-bold text-gray-800 mb-4">Contact Us</h2>
                <p class="text-lg text-gray-600 mb-6">Your feedback is invaluable. Please reach out with questions or suggestions.</p>
                <div class="text-gray-700 text-lg space-y-2">
                    <p><strong>Email:</strong> contact@cricketfield.dev</p>
                    <p><strong>Twitter:</strong> @CFScorer</p>
                </div>
            </div>
        </section>
    </main>
    
    <footer class="text-center py-8 mt-8 border-t border-green-900">
        <p class="text-green-200 text-sm">&copy; 2024 CricketField Scorer. All Rights Reserved.</p>
        <p class="text-green-300 text-xs mt-1">Designed & Developed by Krishnakanth & Sai Kiran</p>
    </footer>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-red-700 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 translate-y-3 transition-all duration-300 font-semibold">
        <p id="toast-message"></p>
    </div>

<script type="module">
    // --- Firebase SDKs ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- App State ---
    let app, auth, db;
    let currentUserId = null;
    let currentRoomId = null;
    let isHost = false;
    let unsubscribe = null; 
    let matchesCollectionPath = '';
    let localMatchState = null;

    // --- UI Elements ---
    let sections, navLinks, mobileMenu, mobileMenuButton, toast, toastMessage;
    let myTeamPlayersContainer, opponentTeamPlayersContainer;

    // --- Global Functions (accessible from HTML) ---
    window.showSection = showSection;
    window.createRoom = createRoom;
    window.joinRoom = joinRoom;
    window.addPlayer = addPlayer;
    window.removePlayer = removePlayer;
    window.selectDismissal = selectDismissal;
    window.updateStrikeRate = updateStrikeRate;
    window.generateResult = generateResult;
    window.saveMatchData = saveMatchData;
    window.clearAllData = clearAllData;
    window.downloadCSV = downloadCSV;
    window.copyRoomId = copyRoomId;
    window.goHome = goHome;
    
    // --- Main Initialization ---
    async function main() {
        const firebaseConfig = JSON.parse(
            typeof __firebase_config !== "undefined"
                ? __firebase_config
                : '{ "apiKey": "dummy", "authDomain": "dummy", "projectId": "dummy" }'
        );
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        matchesCollectionPath = `artifacts/${appId}/public/data/matches`;

        initializeUIElements();

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug');

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                }
            });
            
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }
    }
    
    function initializeUIElements() {
        sections = document.querySelectorAll('.section');
        navLinks = document.querySelectorAll('.nav-link');
        mobileMenu = document.getElementById('mobile-menu');
        mobileMenuButton = document.getElementById('mobile-menu-button');
        toast = document.getElementById('toast');
        toastMessage = document.getElementById('toast-message');
        myTeamPlayersContainer = document.getElementById('myTeamPlayers');
        opponentTeamPlayersContainer = document.getElementById('opponentTeamPlayers');
        
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
    }

    document.addEventListener('DOMContentLoaded', main);

    // --- UI/UX Functions ---
    function showLoader(text) {
        showSection('create-match');
        document.getElementById('scorecard-loader').classList.remove('hidden');
        document.getElementById('loader-text').textContent = text;
        document.getElementById('scorecard-content').classList.add('hidden');
    }

    function hideLoader() {
        document.getElementById('scorecard-loader').classList.add('hidden');
        document.getElementById('scorecard-content').classList.remove('hidden');
    }

    // --- Navigation ---
    function showSection(sectionId, fromMobile = false) {
        sections.forEach(section => section.classList.remove('active'));
        const targetSection = document.getElementById(sectionId);
        if(targetSection) targetSection.classList.add('active');
        
        navLinks.forEach(link => {
            link.classList.remove('active');
            const linkTarget = link.getAttribute('onclick').match(/'([^']+)'/)[1];
            if(linkTarget === sectionId) {
                link.classList.add('active');
            }
        });

        if (sectionId === 'view-prediction' && currentRoomId) {
            displayResults();
        }

        if (fromMobile) {
            mobileMenu.classList.add('hidden');
        }
    }

    function goHome() {
        if(unsubscribe) unsubscribe();
        currentRoomId = null;
        isHost = false;
        localMatchState = null;
        document.getElementById('room-info').classList.add('hidden');
        showSection('home');
    }

    // --- Toast Notification ---
    function showToast(message, duration = 3000) {
        toastMessage.textContent = message;
        toast.classList.remove('opacity-0', 'translate-y-3');
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-3');
        }, duration);
    }

    // --- Multiplayer & Room Management ---
    async function createRoom() {
        if (!db || !currentUserId) return;
        
        showLoader("Creating your match room...");
        isHost = true;

        const matchData = {
            hostId: currentUserId,
            createdAt: new Date().toISOString(),
            myTeam: { name: 'My Team', players: Array(5).fill({}).map(() => ({ name: '', runs: '', balls: '', dismissal: 'Not Out' })) },
            opponentTeam: { name: 'Opponent Team', players: Array(5).fill({}).map(() => ({ name: '', runs: '', balls: '', dismissal: 'Not Out' })) }
        };
        
        try {
            const docRef = await addDoc(collection(db, matchesCollectionPath), matchData);
            currentRoomId = docRef.id;
            document.getElementById('roomIdDisplay').textContent = currentRoomId;
            document.getElementById('room-info').classList.remove('hidden');
            listenToRoom(currentRoomId);
        } catch (error) {
            console.error("Error creating room: ", error);
            showToast("Failed to create room.");
            goHome();
        }
    }

    async function joinRoom() {
        const roomIdInput = document.getElementById('joinRoomInput');
        const roomId = roomIdInput.value.trim();
        if (!roomId || !db) return;

        showLoader(`Joining room ${roomId}...`);
        
        const docRef = doc(db, matchesCollectionPath, roomId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            currentRoomId = roomId;
            isHost = docSnap.data().hostId === currentUserId;
            listenToRoom(currentRoomId);
        } else {
            showToast("Room not found!");
            goHome();
        }
    }
    
    function listenToRoom(roomId) {
        if (unsubscribe) unsubscribe(); 
        
        unsubscribe = onSnapshot(doc(db, matchesCollectionPath, roomId), (doc) => {
            localMatchState = doc.data();
            if (localMatchState) {
                hideLoader();
                updateUIWithData(localMatchState);
            } else {
                goHome();
                showToast("The match has ended or the room was deleted.");
            }
        });
    }
    
    // --- Intelligent UI Syncing ---
    function updateUIWithData(data) {
        const myTeamNameInput = document.getElementById('myTeamName');
        if(myTeamNameInput.value !== data.myTeam.name) myTeamNameInput.value = data.myTeam.name;

        const opponentTeamNameInput = document.getElementById('opponentTeamName');
        if(opponentTeamNameInput.value !== data.opponentTeam.name) opponentTeamNameInput.value = data.opponentTeam.name;

        syncPlayerList('myTeam', data.myTeam.players);
        syncPlayerList('opponentTeam', data.opponentTeam.players);
        
        document.getElementById('myTeamSectionHeader').textContent = data.myTeam.name || 'My Team';
        document.getElementById('opponentTeamSectionHeader').textContent = data.opponentTeam.name || 'Opponent Team';

        const scorecardContainer = document.getElementById('scorecard-container');
        if (isHost) {
            scorecardContainer.classList.remove('disabled-ui');
            document.getElementById('host-controls').style.display = 'flex';
        } else {
            scorecardContainer.classList.add('disabled-ui');
            document.getElementById('host-controls').style.display = 'none';
        }
    }
    
    function syncPlayerList(teamType, playersData) {
        const container = teamType === 'myTeam' ? myTeamPlayersContainer : opponentTeamPlayersContainer;
        const domRows = container.querySelectorAll('.player-row');

        // Sync existing rows and remove deleted ones
        for (let i = 0; i < domRows.length; i++) {
            if (i < playersData.length) {
                syncPlayerRow(domRows[i], playersData[i]);
            } else {
                domRows[i].remove();
            }
        }
        
        // Add new rows
        if (domRows.length < playersData.length) {
            for (let i = domRows.length; i < playersData.length; i++) {
                 addPlayer(teamType, playersData[i], true, i);
            }
        }
    }
    
    function syncPlayerRow(rowElement, playerData) {
        const nameInput = rowElement.querySelector('.player-name-input');
        if(nameInput.value !== playerData.name) nameInput.value = playerData.name;
        
        const runsInput = rowElement.querySelector('.runs-input');
        if(runsInput.value !== playerData.runs) runsInput.value = playerData.runs;

        const ballsInput = rowElement.querySelector('.balls-input');
        if(ballsInput.value !== playerData.balls) ballsInput.value = playerData.balls;

        const dismissalContainer = rowElement.querySelector('.dismissal-container');
        if(dismissalContainer.dataset.dismissal !== playerData.dismissal) {
             dismissalContainer.dataset.dismissal = playerData.dismissal;
             dismissalContainer.querySelectorAll('.dismissal-btn').forEach(btn => {
                 btn.classList.toggle('selected', btn.textContent === playerData.dismissal);
             });
        }
        
        const srDisplay = rowElement.querySelector('.strike-rate-display');
        const sr = playerData.balls > 0 ? ((playerData.runs / playerData.balls) * 100).toFixed(1) : '0.0';
        if(srDisplay.textContent !== sr) srDisplay.textContent = sr;
    }


    function copyRoomId() {
        if(navigator.clipboard && currentRoomId){
            navigator.clipboard.writeText(currentRoomId).then(() => {
                showToast("Room ID copied to clipboard!");
            });
        } else {
             const textArea = document.createElement("textarea");
             textArea.value = currentRoomId;
             document.body.appendChild(textArea);
             textArea.focus();
             textArea.select();
             try {
                document.execCommand('copy');
                showToast("Room ID copied to clipboard!");
             } catch (err) {
                showToast('Failed to copy Room ID.');
             }
             document.body.removeChild(textArea);
        }
    }

    // --- Player Management ---
    function addPlayer(teamType, player = { name: '', runs: '', balls: '', dismissal: 'Not Out' }, isRendering = false, index = null) {
        if (!isHost && !isRendering) return;

        const container = teamType === 'myTeam' ? myTeamPlayersContainer : opponentTeamPlayersContainer;
        if (!container) return; 
        
        const playerIndex = (index !== null) ? index : container.children.length;

        if (playerIndex >= 11) {
            if(!isRendering) showToast('Maximum of 11 players allowed.');
            return;
        }

        const playerDiv = document.createElement('div');
        playerDiv.className = 'player-row bg-white p-4 rounded-lg border border-gray-200 space-y-4 shadow-sm';
        playerDiv.dataset.index = playerIndex;
        
        const dismissalOptions = ['Not Out', 'Bowled', 'Caught', 'LBW', 'Run Out', 'Stumped'];
        const dismissalButtons = dismissalOptions.map(opt => 
            `<button type="button" class="dismissal-btn ${opt === player.dismissal ? 'selected' : ''}" onclick="selectDismissal(this)">${opt}</button>`
        ).join('');

        playerDiv.innerHTML = `
            <div class="flex justify-between items-start">
                <input type="text" value="${player.name}" class="player-name-input text-xl font-semibold text-gray-800 bg-transparent border-0 border-b-2 border-gray-300 focus:ring-0 focus:border-red-700 rounded-none p-1 flex-grow mr-4" placeholder="Player ${playerIndex + 1} Name" oninput="saveMatchData()">
                <button onclick="removePlayer(this)" class="bg-gray-200 hover:bg-red-200 text-red-700 rounded-full p-2 h-8 w-8 flex items-center justify-center flex-shrink-0 transition-colors">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div class="bg-gray-100 rounded-lg p-3 grid grid-cols-3 gap-2 text-center items-center">
                    <div>
                        <label class="text-sm text-gray-500">Runs</label>
                        <input type="number" value="${player.runs}" class="runs-input form-input !p-0 !bg-transparent !border-0 !rounded-none focus:!ring-0" placeholder="0" oninput="updateStrikeRate(this)">
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">Balls</label>
                        <input type="number" value="${player.balls}" class="balls-input form-input !p-0 !bg-transparent !border-0 !rounded-none focus:!ring-0" placeholder="0" oninput="updateStrikeRate(this)">
                    </div>
                    <div class="border-l border-gray-200">
                        <label class="text-sm text-gray-500 uppercase">SR</label>
                        <span class="strike-rate-display font-roboto-slab font-bold text-3xl text-gray-800 block">0.0</span>
                    </div>
                </div>
                 <div>
                    <label class="text-sm text-gray-600 mb-2 block">Dismissal</label>
                     <div class="dismissal-container flex flex-wrap gap-2" data-dismissal="${player.dismissal}">
                        ${dismissalButtons}
                     </div>
                 </div>
            </div>
        `;
        
        container.appendChild(playerDiv);
        updateStrikeRate(playerDiv.querySelector('.runs-input'));

        if (!isRendering) saveMatchData();
    }
    
    function selectDismissal(btn) {
        const container = btn.parentElement;
        container.querySelectorAll('.dismissal-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        container.dataset.dismissal = btn.textContent;
        saveMatchData();
    }

    function removePlayer(button) {
        const playerDiv = button.closest('.player-row');
        playerDiv.remove();
        saveMatchData();
    }
    
    function updateStrikeRate(inputElement) {
        const playerRow = inputElement.closest('.player-row');
        const runs = parseInt(playerRow.querySelector('.runs-input').value) || 0;
        const balls = parseInt(playerRow.querySelector('.balls-input').value) || 0;
        const srDisplay = playerRow.querySelector('.strike-rate-display');
        srDisplay.textContent = balls > 0 ? `${((runs / balls) * 100).toFixed(1)}` : `0.0`;
        saveMatchData();
    }

    // --- Data Handling ---
    function getTeamData(teamType) {
        const container = teamType === 'myTeam' ? myTeamPlayersContainer : opponentTeamPlayersContainer;
        const nameInput = teamType === 'myTeam' ? document.getElementById('myTeamName') : document.getElementById('opponentTeamName');
        const teamName = nameInput.value.trim() || (teamType === 'myTeam' ? 'My Team' : 'Opponent Team');
        
        const players = Array.from(container.querySelectorAll('.player-row')).map((row) => {
            const name = row.querySelector('.player-name-input').value.trim() || `Player ${Array.from(container.children).indexOf(row) + 1}`;
            const runs = row.querySelector('.runs-input').value || '0';
            const balls = row.querySelector('.balls-input').value || '0';
            const dismissal = row.querySelector('.dismissal-container').dataset.dismissal || 'Not Out';
            return { name, runs, balls, dismissal };
        });
        
        return { name: teamName, players };
    }
    
    async function saveMatchData() {
        if (!isHost || !currentRoomId || !db) return;
        
        const matchDocRef = doc(db, matchesCollectionPath, currentRoomId);
        await setDoc(matchDocRef, { 
            myTeam: getTeamData('myTeam'), 
            opponentTeam: getTeamData('opponentTeam') 
        }, { merge: true });
    }

    async function clearAllData() {
        if (!isHost) return;
        if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
            const matchData = {
                myTeam: { name: 'My Team', players: Array(5).fill({}).map(() => ({ name: '', runs: '', balls: '', dismissal: 'Not Out' })) },
                opponentTeam: { name: 'Opponent Team', players: Array(5).fill({}).map(() => ({ name: '', runs: '', balls: '', dismissal: 'Not Out' })) },
            };
            const matchDocRef = doc(db, matchesCollectionPath, currentRoomId);
            await setDoc(matchDocRef, matchData, { merge: true });
            showToast('All data has been cleared.');
        }
    }
    
    // --- Result Calculation and Display ---
    function generateResult() {
        showSection('view-prediction');
    }

    async function displayResults() {
        if(!currentRoomId || !localMatchState) {
             document.getElementById('predictionError').classList.remove('hidden');
             return;
        }
        
        document.getElementById('predictionError').classList.add('hidden');
        document.getElementById('winnerResult').classList.remove('hidden');
        document.getElementById('downloadCsvBtn').classList.remove('hidden');
        
        const myTeamStats = calculateTeamStats(localMatchState.myTeam);
        const opponentTeamStats = calculateTeamStats(localMatchState.opponentTeam);

        populateResultTable('myTeam', myTeamStats);
        populateResultTable('opponentTeam', opponentTeamStats);
        
        const winnerText = document.getElementById('winnerText');
        const winnerReason = document.getElementById('winnerReason');
        
        if (myTeamStats.totalRuns > opponentTeamStats.totalRuns) {
            winnerText.textContent = `${myTeamStats.name} Won!`;
            winnerReason.textContent = `Final score: ${myTeamStats.totalRuns} to ${opponentTeamStats.totalRuns}`;
        } else if (opponentTeamStats.totalRuns > myTeamStats.totalRuns) {
            winnerText.textContent = `${opponentTeamStats.name} Won!`;
            winnerReason.textContent = `Final score: ${opponentTeamStats.totalRuns} to ${myTeamStats.totalRuns}`;
        } else {
            winnerText.textContent = `Match Tied!`;
            winnerReason.textContent = `Both teams scored ${myTeamStats.totalRuns} runs.`;
        }
    }

    function calculateTeamStats(teamData) {
        if (!teamData || !teamData.players) {
            return { name: teamData?.name || 'Team', players: [], totalRuns: 0, totalBalls: 0, wickets: 0, avgStrikeRate: 0 };
        }
        let totalRuns = 0;
        let totalBalls = 0;
        const playersWithStats = teamData.players.map(p => {
            const runs = Number(p.runs) || 0;
            const balls = Number(p.balls) || 0;
            totalRuns += runs;
            totalBalls += balls;
            const strikeRate = (balls > 0) ? ((runs / balls) * 100) : 0;
            return {...p, runs, balls, strikeRate};
        });
        const wickets = teamData.players.filter(p=>p.dismissal !== 'Not Out').length;
        const avgStrikeRate = totalBalls > 0 ? (totalRuns / totalBalls) * 100 : 0;
        return { name: teamData.name, players: playersWithStats, totalRuns, totalBalls, wickets, avgStrikeRate};
    }

    function populateResultTable(teamType, teamData) {
        const tableBody = document.getElementById(`${teamType}ResultBody`);
        document.getElementById(`${teamType}ResultHeader`).textContent = `${teamData.name} - Scoreboard`;
        tableBody.innerHTML = '';

        if (!teamData.players || teamData.players.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No data.</td></tr>';
            return;
        }
        
        teamData.players.forEach(p => {
            const row = tableBody.insertRow();
            const runsDisplay = p.dismissal === 'Not Out' ? `<span class="text-gray-800">${p.runs}*</span>` : `<span class="text-gray-800">${p.runs}</span>`;
            row.innerHTML = `
                <td class="py-4 px-4 font-semibold text-gray-800">${p.name}</td>
                <td class="py-4 px-4 text-left text-gray-500">${p.dismissal}</td>
                <td class="py-4 px-4 text-center font-bold">${runsDisplay}</td>
                <td class="py-4 px-4 text-center text-gray-500">${p.balls}</td>
                <td class="py-4 px-4 text-center font-semibold text-red-700">${p.strikeRate.toFixed(2)}</td>
            `;
        });
        
        document.getElementById(`${teamType}Totals`).innerHTML = `
            <span class="text-gray-600">Total: <strong class="text-gray-800">${teamData.totalRuns} / ${teamData.wickets}</strong></span><br>
            <span class="text-gray-600">Avg SR: <strong class="text-red-700">${teamData.avgStrikeRate.toFixed(2)}</strong></span>
        `;
    }

    function downloadCSV() {
        const myTeamData = calculateTeamStats(getTeamData('myTeam'));
        const opponentTeamData = calculateTeamStats(getTeamData('opponentTeam'));
        let csvContent = "data:text/csv;charset=utf-8,Team,Player,Runs,Balls Faced,Strike Rate,Dismissal\n";
        
        const addTeamToCsv = (team) => {
            team.players.forEach(p => {
                csvContent += `${team.name.replace(/,/g, '')},${p.name.replace(/,/g, '')},${p.runs},${p.balls},${p.strikeRate.toFixed(2)},${p.dismissal}\n`;
            });
            csvContent += `${team.name} Totals,,${team.totalRuns},${team.totalBalls},${team.avgStrikeRate.toFixed(2)},For ${team.wickets} Wickets\n\n`;
        };
        
        addTeamToCsv(myTeamData);
        addTeamToCsv(opponentTeamData);
        
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", "cricket_match_stats.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

</script>

</body>
</html>
